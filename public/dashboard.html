<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Rate Monitor Dashboard</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f7;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #1a1a2e;
            margin-bottom: 10px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .heart-rate-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }
        
        .heart-icon {
            font-size: 48px;
            color: #e74c3c;
            margin-bottom: 10px;
            animation: pulse 1.5s ease infinite;
        }
        
        .heart-rate-value {
            font-size: 72px;
            font-weight: bold;
            margin: 10px 0;
            transition: color 0.5s ease;
        }
        
        .heart-rate-label {
            font-size: 18px;
            color: #777;
            margin-bottom: 5px;
        }
        
        .heart-rate-zone {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
        }
        
        .signal-quality {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .quality-dots {
            display: flex;
            margin-left: 10px;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 3px;
            background-color: #ddd;
        }
        
        .dot.active {
            background-color: #2ecc71;
        }
        
        .trend-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .trend-arrow {
            font-size: 24px;
            margin-left: 10px;
        }
        
        .rising {
            color: #e74c3c;
        }
        
        .falling {
            color: #3498db;
        }
        
        .stable {
            color: #2ecc71;
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
        }
        
        .acquisition-progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .signal-status {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .connected {
            background-color: #2ecc71;
        }
        
        .disconnected {
            background-color: #e74c3c;
        }
        
        .info-panel {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .debug-info {
            font-family: monospace;
            font-size: 12px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .details-label {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
        }
        
        .phase-indicator {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        
        .phase-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
            margin: 0 5px;
        }
        
        .phase-dot.active {
            background-color: #3498db;
        }
        
        .phase-label {
            font-size: 16px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Heart Rate Monitor Dashboard</h1>
            <p>Real-time PPG data visualization and processing</p>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <div class="heart-rate-display">
                    <div class="heart-icon">❤️</div>
                    <div class="heart-rate-value" id="heartRateDisplay">--</div>
                    <div class="details-label" id="heartRateDetails">No signal</div>
                    
                    <div class="heart-rate-zone" id="heartRateZone">Rest</div>
                    
                    <div class="status-container">
                        <div class="signal-status">
                            <div class="status-indicator disconnected" id="signalIndicator"></div>
                            <span id="signalStatus">No Signal</span>
                        </div>
                        
                        <div class="phase-indicator">
                            <div class="phase-dot" id="phaseNone"></div>
                            <div class="phase-dot" id="phaseAcquiring"></div>
                            <div class="phase-dot" id="phaseRefining"></div>
                            <div class="phase-dot" id="phaseTracking"></div>
                            <div class="phase-dot" id="phaseDisruption"></div>
                        </div>
                        <div class="phase-label" id="phaseLabel">No Signal</div>
                    </div>
                    
                    <div class="acquisition-progress" id="acquisitionProgressContainer" style="display: none;">
                        <div class="progress-bar" id="acquisitionProgress"></div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="chart-container">
                    <canvas id="ppgChart"></canvas>
                </div>
                <div class="info-panel">
                    <p>Last update: <span id="lastUpdate">Never</span></p>
                    <p>Signal quality: <span id="signalQuality">0%</span></p>
                    <p>Connected clients: <span id="clientCount">1</span></p>
                    <button id="toggleDebug">Show Debug Info</button>
                    <div class="debug-info" id="debugInfo"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // WebSocket Connection
        let ws;
        let heartRateData = [];
        let ppgData = Array(500).fill(0);
        let heartRateChart;
        let ppgChart;
        let lastHeartRate = 0;
        let showDebug = false;
        
        // Heart rate zone colors
        const zoneColors = {
            "Rest": "#3498db",
            "Light": "#2ecc71",
            "Moderate": "#f1c40f",
            "Vigorous": "#e67e22",
            "High": "#e74c3c",
            "Maximum": "#9b59b6"
        };
        
        // Phase names
        const phaseNames = {
            "no_signal": "No Signal",
            "acquiring": "Acquiring",
            "refining": "Refining",
            "tracking": "Tracking",
            "disruption": "Disruption"
        };
        
        // Connect WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('Connected to server');
                document.getElementById('signalStatus').textContent = 'Connected to server';
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                
                if (message.type === 'update' || message.type === 'initial') {
                    // Update PPG data
                    ppgData = message.data;
                    
                    // Update heart rate display
                    updateHeartRateDisplay(message);
                    
                    // Update PPG chart
                    updatePPGChart();
                    
                    // Update last update time
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    
                    // Update debug info
                    updateDebugInfo(message);
                }
            };
            
            ws.onclose = function() {
                console.log('Disconnected from server');
                document.getElementById('signalStatus').textContent = 'Disconnected from server';
                document.getElementById('signalIndicator').classList.remove('connected');
                document.getElementById('signalIndicator').classList.add('disconnected');
                
                // Try to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                document.getElementById('signalStatus').textContent = 'Connection error';
                document.getElementById('signalIndicator').classList.remove('connected');
                document.getElementById('signalIndicator').classList.add('disconnected');
            };
        }
        
        // Update heart rate display with received data
        function updateHeartRateDisplay(data) {
            const heartRateDisplay = document.getElementById('heartRateDisplay');
            const heartRateDetails = document.getElementById('heartRateDetails');
            const heartRateZone = document.getElementById('heartRateZone');
            const signalIndicator = document.getElementById('signalIndicator');
            const signalStatus = document.getElementById('signalStatus');
            const signalQuality = document.getElementById('signalQuality');
            const acquisitionProgress = document.getElementById('acquisitionProgress');
            const acquisitionProgressContainer = document.getElementById('acquisitionProgressContainer');
            
            // Update display value and details
            if (data.display_value) {
                heartRateDisplay.textContent = data.display_value;
                heartRateDetails.textContent = data.display_details || '';
            } else {
                // Fall back to heartRate if display_value not available
                heartRateDisplay.textContent = data.heartRate > 0 ? data.heartRate : '--';
                heartRateDetails.textContent = '';
            }

            // Show/hide acquisition progress based on display details
            if (data.display_value && data.display_value.includes('Wait')) {
                acquisitionProgressContainer.style.display = 'block';
                // Extract percentage from details
                const progressMatch = data.display_details?.match(/(\d+)%/);
                if (progressMatch && progressMatch[1]) {
                    acquisitionProgress.style.width = `${progressMatch[1]}%`;
                }
            } else {
                acquisitionProgressContainer.style.display = 'none';
            }
            
            // Update heart rate zone
            heartRateZone.textContent = data.heartRateZone || 'Rest';
            heartRateZone.style.backgroundColor = zoneColors[data.heartRateZone] || '#3498db';
            
            // Update signal status
            if (data.fingerDetected) {
                signalIndicator.classList.remove('disconnected');
                signalIndicator.classList.add('connected');
                signalStatus.textContent = 'Signal detected';
            } else {
                signalIndicator.classList.remove('connected');
                signalIndicator.classList.add('disconnected');
                signalStatus.textContent = 'No signal';
            }
            
            // Update signal quality
            const qualityPercent = Math.round((data.heartRateQuality || 0) * 100);
            signalQuality.textContent = `${qualityPercent}%`;
            
            // Update phase indication
            updatePhaseIndication(data.phase || 'no_signal');
            
            // Store heartRate for trending
            if (data.heartRate > 0) {
                lastHeartRate = data.heartRate;
            }
        }
        
        // Update phase indication
        function updatePhaseIndication(phase) {
            // Reset all phase dots
            document.getElementById('phaseNone').classList.remove('active');
            document.getElementById('phaseAcquiring').classList.remove('active');
            document.getElementById('phaseRefining').classList.remove('active');
            document.getElementById('phaseTracking').classList.remove('active');
            document.getElementById('phaseDisruption').classList.remove('active');
            
            // Activate current phase dot
            switch(phase) {
                case 'no_signal':
                    document.getElementById('phaseNone').classList.add('active');
                    break;
                case 'acquiring':
                    document.getElementById('phaseAcquiring').classList.add('active');
                    break;
                case 'refining':
                    document.getElementById('phaseRefining').classList.add('active');
                    break;
                case 'tracking':
                    document.getElementById('phaseTracking').classList.add('active');
                    break;
                case 'disruption':
                    document.getElementById('phaseDisruption').classList.add('active');
                    break;
            }
            
            // Update phase label
            document.getElementById('phaseLabel').textContent = phaseNames[phase] || 'Unknown';
        }
        
        // Update PPG chart
        function updatePPGChart() {
            if (!ppgChart) {
                initPPGChart();
            }
            
            // Update chart data
            ppgChart.data.datasets[0].data = ppgData;
            ppgChart.update();
        }
        
        // Initialize PPG chart
        function initPPGChart() {
            const ctx = document.getElementById('ppgChart').getContext('2d');
            
            ppgChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(ppgData.length).fill(''),
                    datasets: [{
                        label: 'PPG Signal',
                        data: ppgData,
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'IR Value'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Update debug info
        function updateDebugInfo(data) {
            if (showDebug) {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.innerHTML = `
                    <p>Heart Rate: ${data.heartRate}</p>
                    <p>Zone: ${data.heartRateZone}</p>
                    <p>Quality: ${(data.heartRateQuality || 0).toFixed(2)}</p>
                    <p>Trend: ${data.heartRateTrend}</p>
                    <p>Finger Detected: ${data.fingerDetected}</p>
                    <p>Display Value: ${data.display_value || 'N/A'}</p>
                    <p>Display Details: ${data.display_details || 'N/A'}</p>
                    <p>Phase: ${data.phase || 'unknown'}</p>
                `;
            }
        }
        
        // Toggle debug info
        document.getElementById('toggleDebug').addEventListener('click', function() {
            showDebug = !showDebug;
            const debugInfo = document.getElementById('debugInfo');
            if (showDebug) {
                debugInfo.style.display = 'block';
                this.textContent = 'Hide Debug Info';
            } else {
                debugInfo.style.display = 'none';
                this.textContent = 'Show Debug Info';
            }
        });
        
        // Connect to WebSocket when page loads
        window.addEventListener('load', function() {
            connectWebSocket();
        });
    </script>
</body>
</html>